<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurator | Availability</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #0b0b0e;
            --card-bg: #14141b;
            --border-color: #252530;
            --text-color: #f8f8f2;
            --pink: #ec4899;
            --available: #00ff9d;
            --busy: #ff4d4d;
            --partial: #ffb347;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); font-size: 16px; }
        .glass-panel { background: rgba(20, 20, 27, 0.7); backdrop-filter: blur(30px); border: 1px solid rgba(255, 255, 255, 0.05); }
        input, select, textarea { background: rgba(255, 255, 255, 0.05) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; color: white !important; outline: none !important; }
        .btn-pink { background: var(--pink); color: white; transition: all 0.2s; }
        .btn-pink:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .dot-available { background: var(--available); }
        .dot-busy { background: var(--busy); }
        .dot-partial { background: var(--partial); }
        .weekday-btn { padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); font-size: 10px; font-weight: 900; text-align: center; cursor: pointer; }
        .weekday-btn.active { background: var(--pink); border-color: var(--pink); }
        @media print { .no-print { display: none !important; } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="antialiased min-h-screen pb-20">

    <header class="bg-[#0b0b0e]/60 backdrop-blur-xl sticky top-0 z-40 border-b border-white/5 no-print">
        <nav class="container mx-auto px-6 flex items-center justify-between h-20">
            <div class="flex items-center gap-4">
                <span class="text-xl font-black uppercase tracking-widest">Configurator</span>
                <span class="px-3 py-1 bg-pink-500/10 text-pink-500 text-[10px] font-black uppercase tracking-widest rounded-full border border-pink-500/20">Admin</span>
            </div>
            <div class="flex gap-3">
                <input type="file" id="fileInput" class="hidden" accept=".json" onchange="handleFileUpload(event)">
                <button onclick="document.getElementById('fileInput').click()" class="px-5 py-2 rounded-xl bg-white/5 border border-white/10 text-xs font-black uppercase tracking-widest hover:bg-white/10">Load JSON</button>
                <button onclick="downloadJson()" class="px-5 py-2 rounded-xl btn-pink text-xs font-black uppercase tracking-widest">Download</button>
            </div>
        </nav>            
    </header>

    <main class="container mx-auto px-6 py-10 max-w-7xl no-print">
        <div id="summaryBox" class="hidden mb-8 glass-panel rounded-2xl p-6 border-l-4 border-emerald-500">
            <div class="flex items-start justify-between">
                <div>
                    <h3 class="text-sm font-black uppercase tracking-widest text-emerald-400 mb-2">Batch Complete</h3>
                    <p id="summaryText" class="text-xs text-gray-400 font-medium"></p>
                </div>
                <button onclick="this.parentElement.parentElement.classList.add('hidden')" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <aside class="lg:col-span-5 space-y-8">
                <div class="glass-panel rounded-[2rem] p-8">
                    <h2 class="text-sm font-black uppercase tracking-[0.2em] mb-6 text-pink-500/80">Global Settings</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2">Certain Until</label>
                                <input type="date" id="certainUntil" class="w-full px-4 py-3 rounded-xl text-sm" onchange="updateSettings()">
                            </div>
                            <div>
                                <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2">Phone #</label>
                                <input type="text" id="userPhone" class="w-full px-4 py-3 rounded-xl text-sm" onchange="updateSettings()" placeholder="+47 ...">
                            </div>
                        </div>
                        <button onclick="togglePrintModal()" class="w-full py-4 rounded-xl bg-white/5 border border-white/10 text-xs font-black uppercase tracking-widest hover:bg-white/10 flex items-center justify-center gap-3">
                            <i class="fas fa-print"></i> PDF Export Range...
                        </button>
                    </div>
                </div>

                <div class="glass-panel rounded-[2rem] p-8">
                    <h2 class="text-sm font-black uppercase tracking-[0.2em] mb-6 text-pink-500/80">Batch Editor</h2>
                    <form id="entryForm" class="space-y-6" onsubmit="processBatch(event)">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2">Start Date</label>
                                <input type="date" id="formDate" required class="w-full px-4 py-3 rounded-xl text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2">End Date</label>
                                <input type="date" id="formEndDate" class="w-full px-4 py-3 rounded-xl text-sm">
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2">Repeat On</label>
                            <div class="grid grid-cols-7 gap-2">
                                <div class="weekday-btn active" data-day="1">M</div>
                                <div class="weekday-btn active" data-day="2">T</div>
                                <div class="weekday-btn active" data-day="3">W</div>
                                <div class="weekday-btn active" data-day="4">T</div>
                                <div class="weekday-btn active" data-day="5">F</div>
                                <div class="weekday-btn" data-day="6">S</div>
                                <div class="weekday-btn" data-day="0">S</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2">Status</label>
                                <select id="formStatus" class="w-full px-4 py-3 rounded-xl text-sm">
                                    <option value="available">Available</option>
                                    <option value="busy">Busy</option>
                                    <option value="partial">Partial</option>
                                </select>
                            </div>
                            <div class="flex items-end mb-3">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="overwriteCheck" checked class="w-4 h-4">
                                    <span class="text-[10px] font-black uppercase tracking-widest text-gray-400">Overwrite</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2">Note</label>
                            <textarea id="formNote" rows="2" class="w-full px-4 py-3 rounded-xl text-sm resize-none"></textarea>
                        </div>
                        <button type="submit" class="w-full py-4 rounded-xl btn-pink text-xs font-black uppercase tracking-widest shadow-lg active:scale-95 transition">Apply Changes</button>
                    </form>
                </div>
            </aside>

            <div class="lg:col-span-7">
                <div class="glass-panel rounded-[2rem] p-8">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-sm font-black uppercase tracking-[0.2em] text-gray-400">Database</h2>
                        <input type="text" id="searchTerm" oninput="renderEntries()" placeholder="Search..." class="w-48 px-4 py-2 rounded-xl text-xs">
                    </div>
                    <div id="entryList" class="space-y-2 max-h-[700px] overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal for Printing Selection -->
    <div id="print-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-6 no-print">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="togglePrintModal()"></div>
        <div class="glass-panel relative w-full max-w-md rounded-[2rem] p-8">
            <h3 class="text-sm font-black uppercase tracking-widest mb-6">Select Range to Print</h3>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2">Start Month</label>
                    <input type="month" id="print-start-month" class="w-full px-4 py-3 rounded-xl text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2">End Month</label>
                    <input type="month" id="print-end-month" class="w-full px-4 py-3 rounded-xl text-sm">
                </div>
            </div>
            <button onclick="executePrint()" class="w-full py-4 rounded-xl btn-pink text-xs font-black uppercase tracking-widest">Generate PDF</button>
        </div>
    </div>

    <script>
        let DATA = { overrides: {}, settings: { certainUntil: '', phone: '' } };
        const weekdayBtns = document.querySelectorAll('.weekday-btn');

        weekdayBtns.forEach(btn => btn.onclick = () => btn.classList.toggle('active'));

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    DATA.overrides = json.overrides || json;
                    DATA.settings = json.settings || { certainUntil: '', phone: '' };
                    document.getElementById('certainUntil').value = DATA.settings.certainUntil || '';
                    document.getElementById('userPhone').value = DATA.settings.phone || '';
                    renderEntries();
                } catch (err) { alert("Invalid JSON"); }
            };
            reader.readAsText(file);
        }

        function updateSettings() {
            DATA.settings.certainUntil = document.getElementById('certainUntil').value;
            DATA.settings.phone = document.getElementById('userPhone').value;
        }

        function togglePrintModal() {
            document.getElementById('print-modal').classList.toggle('hidden');
            if(!document.getElementById('print-start-month').value) {
                const now = new Date();
                document.getElementById('print-start-month').value = now.toISOString().slice(0, 7);
                document.getElementById('print-end-month').value = now.toISOString().slice(0, 7);
            }
        }

        function executePrint() {
            const sm = document.getElementById('print-start-month').value;
            const em = document.getElementById('print-end-month').value;
            if(!sm || !em) return;
            const start = new Date(sm + "-01T00:00:00");
            const end = new Date(em + "-01T00:00:00");
            end.setMonth(end.getMonth() + 1);
            end.setDate(0);
            generatePrintSummary(start, end);
            togglePrintModal();
        }

        function generatePrintSummary(start, end) {
            const portalUrl = "sofialborch.github.io";
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(portalUrl)}`;
            const printWindow = window.open('', '_blank');

            let html = `<html><head><title>Availability - Print View</title><style>
                @page { margin: 0.5cm; size: A4; }
                body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; color: #000; -webkit-print-color-adjust: exact; }
                header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #000; padding: 10px 0; margin-bottom: 15px; }
                h1 { margin: 0; font-size: 20px; font-weight: 900; text-transform: uppercase; letter-spacing: -1px; }
                .meta { font-weight: bold; color: #666; font-size: 9px; text-transform: uppercase; }
                .month-title { font-size: 15px; font-weight: 900; text-transform: uppercase; border-left: 10px solid #000; padding: 4px 12px; margin: 25px 0 10px 0; display: inline-block; break-after: avoid; }
                .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 2px solid #000; margin-bottom: 20px; page-break-inside: avoid; }
                .day-header { background: #000; color: #fff; padding: 5px; font-weight: 900; font-size: 9px; text-transform: uppercase; text-align: center; border: 1px solid #000; }
                .day-cell { background: #fff; min-height: 55px; padding: 5px; border: 1px solid #000; position: relative; overflow: hidden; }
                
                .day-top { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
                .day-num { font-weight: 900; font-size: 12px; line-height: 1; }
                
                .status-badge { font-size: 7.5px; font-weight: 900; text-transform: uppercase; background: #000; color: #fff; padding: 2px 6px; border-radius: 99px; white-space: nowrap; }
                .note-text { font-size: 10px; line-height: 1.1; color: #000; font-weight: 700; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
                .busy-cell { background: #fee2e2 !important; } .available-cell { background: #f0fdf4 !important; } .partial-cell { background: #fef3c7 !important; } .weekend-cell { background: #f8fafc !important; }
                .footer { display: flex; justify-content: space-between; align-items: flex-end; page-break-inside: avoid; }
                .qr-box img { width: 80px; height: 80px; border: 1px solid #000; }
                .trademark { font-weight: 900; font-size: 11px; letter-spacing: 2px; }
                .phone-badge { font-size: 14px; font-weight: 900; margin-top: 8px; background: #000; color: #fff; padding: 4px 12px; border-radius: 6px; display: inline-block; }
                @media print { .no-print { display: none; } }
            </style></head><body>
            <div class="no-print" style="padding: 10px; text-align: center; background: #eee; position: sticky; top: 0;"><button onclick="window.print()" style="padding: 10px 40px; font-weight: 900; cursor: pointer; background: #000; color: #fff; border: none; border-radius: 6px;">PRINT PDF</button></div>
            <div style="padding: 20px;">
            <header><div><h1>Availability Summary</h1><div class="meta">Range: ${start.toLocaleDateString('en-GB', {month:'long', year:'numeric'})} - ${end.toLocaleDateString('en-GB', {month:'long', year:'numeric'})}</div></div><div class="trademark">Z03Y &trade;</div></header>`;

            let iter = new Date(start);
            let currentMonth = -1;
            let monthsRendered = 0;

            while (iter <= end) {
                if (iter.getMonth() !== currentMonth) {
                    if (currentMonth !== -1) html += `</div>`;
                    if (monthsRendered > 0 && monthsRendered % 2 === 0) html += `<div style="page-break-after: always;"></div>`;
                    currentMonth = iter.getMonth();
                    monthsRendered++;
                    html += `<div class="month-title">${iter.toLocaleString('default', { month: 'long', year: 'numeric' })}</div><div class="calendar-grid">
                        <div class="day-header">Mon</div><div class="day-header">Tue</div><div class="day-header">Wed</div>
                        <div class="day-header">Thu</div><div class="day-header">Fri</div><div class="day-header">Sat</div><div class="day-header">Sun</div>`;
                    let firstDayOfGridMonth = new Date(iter.getFullYear(), iter.getMonth(), 1).getDay();
                    let padding = firstDayOfGridMonth === 0 ? 6 : firstDayOfGridMonth - 1;
                    for(let p=0; p<padding; p++) html += `<div class="day-cell empty"></div>`;
                }

                const dateStr = iter.toLocaleDateString('en-CA');
                const info = DATA.overrides[dateStr];
                const isWeekend = iter.getDay() === 0 || iter.getDay() === 6;
                const status = info ? info.status : (isWeekend ? 'weekend' : 'available');
                
                let badge = '';
                if(info && info.note) {
                    const ln = info.note.toLowerCase();
                    if(ln.includes('norønna')) badge = 'NR';
                    else if(ln.includes('polarmåsen')) badge = 'PM';
                    else if(ln.includes('studying')) badge = 'ST';
                }
                
                if(!badge && status !== 'available' && status !== 'weekend') {
                    badge = status === 'partial' ? 'PART' : status.toUpperCase();
                }

                html += `<div class="day-cell ${status}-cell ${isWeekend ? 'weekend-cell' : ''}">
                    <div class="day-top">
                        <span class="day-num">${iter.getDate()}</span>
                        ${badge ? `<span class="status-badge">${badge}</span>` : ''}
                    </div>
                    <div class="note-text">${info ? info.note : ''}</div>
                </div>`;

                let next = new Date(iter);
                next.setDate(iter.getDate() + 1);
                if (next.getMonth() !== currentMonth || next > end) {
                    let lastDay = iter.getDay();
                    let endPadding = lastDay === 0 ? 0 : 7 - lastDay;
                    for(let ep=0; ep<endPadding; ep++) html += `<div class="day-cell empty"></div>`;
                }
                iter = next;
            }

            html += `</div><div class="footer"><div><div class="trademark">PROJECT BY Z03Y</div>${DATA.settings.phone ? `<div class="phone-badge">${DATA.settings.phone}</div>` : ''}<p style="font-size: 9px; color: #555; max-width: 400px; margin-top: 10px; font-weight: 600;">Scan QR to verify status live.</p></div><div class="qr-box"><img src="${qrUrl}"><div style="font-size: 8px; font-weight: 900; margin-top: 5px; text-align: center;">LIVE UPDATES</div></div></div></div></body></html>`;
            printWindow.document.write(html);
            printWindow.document.close();
        }

        function processBatch(event) {
            event.preventDefault();
            const startStr = document.getElementById('formDate').value;
            const endStr = document.getElementById('formEndDate').value || startStr;
            const status = document.getElementById('formStatus').value;
            const note = document.getElementById('formNote').value.trim();
            const doOverwrite = document.getElementById('overwriteCheck').checked;
            const activeDays = Array.from(weekdayBtns).filter(b => b.classList.contains('active')).map(b => parseInt(b.dataset.day));

            let current = new Date(startStr + "T00:00:00");
            const end = new Date(endStr + "T00:00:00");
            let stats = { updated: 0, created: 0, skipped: 0 };

            while (current <= end) {
                if (activeDays.includes(current.getDay())) {
                    const dateStr = current.toLocaleDateString('en-CA');
                    const exists = !!DATA.overrides[dateStr];
                    if (!exists || doOverwrite) {
                        if (exists) stats.updated++; else stats.created++;
                        DATA.overrides[dateStr] = { status, note };
                    } else stats.skipped++;
                }
                current.setDate(current.getDate() + 1);
            }
            showSummary(stats);
            renderEntries();
        }

        function showSummary(stats) {
            const box = document.getElementById('summaryBox');
            box.classList.remove('hidden');
            document.getElementById('summaryText').innerText = `${stats.created} created, ${stats.updated} updated.`;
        }

        function editEntry(date) {
            const entry = DATA.overrides[date];
            document.getElementById('formDate').value = date;
            document.getElementById('formEndDate').value = "";
            document.getElementById('formStatus').value = entry.status;
            document.getElementById('formNote').value = entry.note;
            const d = new Date(date + "T00:00:00").getDay();
            weekdayBtns.forEach(b => b.classList.toggle('active', parseInt(b.dataset.day) === d));
        }

        function renderEntries() {
            const list = document.getElementById('entryList');
            const term = document.getElementById('searchTerm').value.toLowerCase();
            list.innerHTML = '';
            const sortedDates = Object.keys(DATA.overrides).sort((a, b) => new Date(b) - new Date(a));
            sortedDates.forEach(date => {
                const entry = DATA.overrides[date];
                if (date.includes(term) || (entry.note && entry.note.toLowerCase().includes(term))) {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between p-4 rounded-xl bg-white/[0.02] border border-white/5 hover:border-white/10 group";
                    div.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="status-dot dot-${entry.status}"></div>
                            <div>
                                <div class="text-sm font-bold">${date} <span class="text-[9px] text-gray-500 uppercase ml-2">${new Date(date + "T00:00:00").toLocaleDateString('en-GB', {weekday:'short'})}</span></div>
                                <div class="text-[11px] text-gray-500">${entry.note || '-'}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="editEntry('${date}')" class="p-2 hover:text-white transition"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteEntry('${date}')" class="p-2 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                        </div>`;
                    list.appendChild(div);
                }
            });
        }

        function downloadJson() {
            const blob = new Blob([JSON.stringify(DATA, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'availability.json';
            a.click();
        }

        function deleteEntry(date) { delete DATA.overrides[date]; renderEntries(); }
        window.onload = renderEntries;
    </script>
</body>
</html>